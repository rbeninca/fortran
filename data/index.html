<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GFIG üöÄ - Balan√ßa Wi-Fi</title>

  <script src="apexcharts"></script>
  <link rel="stylesheet" href="/estilo.css">
  <script src="script_grafico_sessao.js" defer></script>
  <script src="funcoespdf.js" defer></script>
  <script src="script.js" defer></script>
</head>

<body>
  <div class="container">
        <div id="alerta-estabilizacao">
      ‚ö†Ô∏è A balan√ßa n√£o est√° estabilizando! A toler√¢ncia pode estar muito baixa.
      V√° em Par√¢metros ‚Üí Toler√¢ncia de Estabilidade e aumente o valor.
    </div>

    <div class="sticky-header-group">
      <div class="leituras-display">
        <div class="leituras-valores">
          <div>
            <h4>For√ßa Atual</h4>
            <p id="forca-atual">---</p>
          </div>
          <div>
            <h4>For√ßa EMS</h4>
            <p id="forca-ems">---</p>
          </div>
          <div>
            <h4>For√ßa M√°xima</h4>
            <p id="forca-maxima">---</p>
            <small id="forca-minima" style="display: block; font-size: 0.75rem; color: var(--cor-texto-secundario);">m√≠n: ---</small>
          </div>
          <div>
            <h4>Leituras/Seg</h4>
            <p id="leituras-por-segundo">---</p>
          </div>
        </div>
        <div class="unidade-selecao">
          <div class="btn-grupo" role="group">
            <button id="btn-unit-n" class="btn" onclick="setDisplayUnit('N')">Newtons (N)</button>
            <button id="btn-unit-gf" class="btn" onclick="setDisplayUnit('gf')">Grama-for√ßa (gf)</button>
            <button id="btn-unit-kgf" class="btn" onclick="setDisplayUnit('kgf')">Quilo-for√ßa (kgf)</button>
          </div>
        </div>
      </div>

      <div class="nav-abas">
        <nav>
          <button class="tablink" onclick="abrirAba(this, 'abaGrafico')" id="padrao">üìà Gr√°fico</button>
          <button class="tablink" onclick="abrirAba(this, 'abaTabela')">üìã Tabela</button>
          <button class="tablink" onclick="abrirAba(this, 'abaGravacoes')">üíæ Grava√ß√µes</button>
          <button class="tablink" onclick="abrirAba(this, 'abaControles')">‚öôÔ∏è Par√¢metros</button>
          <button class="tablink" onclick="abrirAba(this, 'abaConexao')">üîå Conex√£o</button>
        </nav>
      </div>
    </div>
    <main>
      <div id="abaGrafico" class="tabcontent">
        <div class="controles-grafico-sessao" style="margin-bottom: 0.5rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem;">
          
          <!-- New input for MAX_DATA_POINTS -->
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--cor-borda); border-radius: 0.5rem;">
            <label for="max-data-points-input" id="max-data-points-label">Max Pontos:</label>
            <input type="number" id="max-data-points-input" value="100" min="10" step="10" style="width: 80px;" title="N√∫mero m√°ximo de pontos no modo deslizante. No modo acumulado, mostra a contagem atual.">
          </div>

          <div class="btn-grupo">
            <button id="btn-toggle-labels" class="btn" onclick="toggleDataLabels()">Mostrar/Ocultar Labels</button>
            <button id="btn-toggle-display-mode" class="btn" onclick="toggleChartDisplayMode()">Modo: Somente Pontos</button>
            <button id="btn-toggle-grid" class="btn" onclick="toggleGrid()">Grade: ON</button>
            <button id="btn-set-smooth-line" class="btn" onclick="setInterpolation('smooth')">Linha Suave</button>
            <button id="btn-set-straight-line" class="btn" onclick="setInterpolation('straight')">Linha Reta</button>
          </div>
          <div class="btn-grupo">
            <button id="btn-toggle-fullscreen" class="btn" onclick="toggleFullscreen()">Tela Cheia</button>
            <button class="btn" onclick="setYAxisRange('auto')">Range Autom√°tico</button>
            <button class="btn" onclick="setYAxisRange('fixed')">Range Fixo (C√©lula)</button>
          </div>
          <div class="btn-grupo">
            <button id="btn-anti-noising" class="btn" onclick="toggleAntiNoising()">Anti-Noising: Off</button>
            <button id="btn-zona-morta" class="btn" onclick="toggleFiltroZonaMorta()" style="background: #27ae60;">Zona Morta: ON</button>
            <button id="btn-arredondamento" class="btn" onclick="toggleArredondamentoInteligente()" style="background: #27ae60;">Arredondar: ON</button>
          </div>
          
          <div id="status-filtros" style="margin-top: 0.5rem; padding: 0.5rem; background: #ecf0f1; border-radius: 0.5rem; font-size: 0.875rem;">
            <strong>üìä Filtros da C√©lula:</strong>
            <span id="info-zona-morta" style="margin-left: 1rem; color: #27ae60;">‚úì Zona Morta (¬±0.0g)</span>
            <span id="info-arredondamento" style="margin-left: 1rem; color: #27ae60;">‚úì Arredondamento (0 casas)</span>
          </div>
        </div>

        <div class="grafico-e-controles" style="display: flex; align-items: flex-start; gap: 1rem; flex-wrap: nowrap;">
          <div id="grafico" class="ct-chart" style="flex-grow: 1;"></div>
          <div class="controles-laterais" style="display: flex; flex-direction: column; gap: 0.5rem;">
            <div class="btn-grupo" style="flex-direction: column;">
              <button id="btn-deslizante" class="btn" onclick="setChartMode('deslizante')">Deslizante</button>
              <button id="btn-acumulado" class="btn" onclick="setChartMode('acumulado')">Acumulado</button>
              <button id="btn-pausado" class="btn" onclick="toggleChartPause()">Pausar/Retomar</button>
              <button onclick="clearChart()" class="btn btn-secundario">Limpar Gr√°fico</button>
            </div>
            
            <!-- Controles de grava√ß√£o movidos para c√° -->
            <div class="controle-gravacao" style="display: flex; flex-direction: column; gap: 0.375rem; padding: 0.5rem; border: 1px solid var(--cor-borda); border-radius: 0.5rem; background: var(--cor-fundo-card);">
              <input type="text" id="nome-sessao" placeholder="Nome da Sess√£o..." style="width: 100%; padding: 0.375rem 0.5rem; font-size: 0.7rem;">
              <button id="btn-iniciar-sessao" onclick="iniciarSessao()" class="btn btn-sucesso" style="width: 100%; padding: 0.375rem 0.5rem; font-size: 0.7rem;">‚ñ∂ Iniciar</button>
              <button id="btn-encerrar-sessao" onclick="encerrarSessao()" class="btn btn-perigo" disabled style="width: 100%; padding: 0.375rem 0.5rem; font-size: 0.7rem;">‚èπ Encerrar</button>
            </div>
          </div>
        </div>
      </div>
      <div id="abaTabela" class="tabcontent">
        <div class="tabela-container">
          <table id="tabela">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Tempo ESP (s)</th>
                <th>Newtons (N)</th>
                <th>Grama-for√ßa (gf)</th>
                <th>Quilo-for√ßa (kgf)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div id="abaControles" class="tabcontent">
        <section>
          <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Par√¢metros da Balan√ßa</h2>
          <p style="font-size: 0.875rem; color: var(--cor-texto-secundario); margin-bottom: 1rem;">Estes s√£o os valores
            atuais em uso.</p>
          <div class="grid-container" style="gap: 1rem;">
            <div><label for="param-conversao">Fator de Convers√£o</label><input id="param-conversao" type="number"
                step="any"></div>
            <div><label for="param-gravidade">Gravidade (m/s¬≤)</label><input id="param-gravidade" type="number"
                step="any">
            </div>
            <div><label for="param-offset">Offset de Tara Salvo</label><input id="param-offset"
                style="padding: 0.5rem 0.75rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                readonly></input>
            </div>
          </div>

          <h3 style="font-size: 1.125rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">
            ‚öñÔ∏è Especifica√ß√µes da C√©lula de Carga
          </h3>
          <p style="font-size: 0.875rem; color: var(--cor-texto-secundario); margin-bottom: 0.75rem;">
            Configure a capacidade e precis√£o da sua c√©lula para melhor filtragem e visualiza√ß√£o.
          </p>
          <div class="grid-container" style="gap: 1rem;">
            <div>
              <label for="param-capacidade-maxima">Capacidade M√°xima (g)</label>
              <input id="param-capacidade-maxima" type="number" step="any" oninput="atualizarCapacidadeEmKg()">
              <small id="capacidade-em-kg"
                style="color: var(--cor-texto-secundario); display: block; margin-top: 0.25rem;">‚âà 5.00 kg</small>
            </div>
            <div>
              <label for="param-acuracia">Acur√°cia (%)</label>
              <input id="param-acuracia" type="number" step="0.001" oninput="atualizarErroAbsoluto()">
              <small id="erro-absoluto"
                style="color: var(--cor-texto-secundario); display: block; margin-top: 0.25rem;">Erro: ¬±0.00 g</small>
              <small style="color: var(--cor-info); display: block; margin-top: 0.25rem;">
                üí° Valores t√≠picos: 0.03% a 0.1%
              </small>
            </div>
          </div>

          <h3 style="font-size: 1.125rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">Par√¢metros de
            Estabiliza√ß√£o</h3>
          <div class="grid-container" style="gap: 1rem;">
            <div><label for="param-leituras-estaveis">Leituras Est√°veis</label><input id="param-leituras-estaveis"
                type="number"></div>
            <div>
              <label for="param-tolerancia">Toler√¢ncia de Estabilidade</label>
              <input id="param-tolerancia" type="number" step="any" oninput="atualizarToleranciaEmGramas()">
              <small id="tolerancia-em-gramas"
                style="color: var(--cor-texto-secundario); display: block; margin-top: 0.25rem;">‚âà 0.00 g</small>
              <small style="color: var(--cor-aviso); display: block; margin-top: 0.25rem;">
                ‚ö†Ô∏è Se a balan√ßa n√£o estabiliza, aumente este valor!
              </small>
            </div>
            <div><label for="param-num-amostras">N¬∫ Amostras para M√©dia</label><input id="param-num-amostras"
                type="number">
            </div>
            <div><label for="param-timeout">Timeout de Calibra√ß√£o (ms)</label><input id="param-timeout" type="number">
            </div>
            <div>
              <label for="taxa-atualizacao">Taxa de Atualiza√ß√£o do Gr√°fico (ms)</label>
              <input id="taxa-atualizacao" type="number" min="10" max="1000" step="10" value="100">
              <small id="taxa-info" style="color: var(--cor-texto-secundario); display: block; margin-top: 0.25rem;">‚âà 10 atualiza√ß√µes/seg</small>
            </div>
          <button onclick="salvarParametros()" class="btn btn-sucesso" style="margin-top: 1.5rem;">Salvar Todos os
            Par√¢metros</button>
        </section>

        <section style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--cor-borda);">
          <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
            üîä Configura√ß√µes de Anti-Noising
          </h3>
          <p style="font-size: 0.875rem; color: var(--cor-texto-secundario); margin-bottom: 1rem;">
            Configure a an√°lise e redu√ß√£o de ru√≠do da balan√ßa. Use <kbd>Shift+A</kbd> para iniciar an√°lise de ru√≠do.
          </p>
          
          <div class="grid-container" style="gap: 1rem;">
            <div>
              <label for="anti-noising-multiplier">Multiplicador de Threshold</label>
              <input id="anti-noising-multiplier" type="number" step="0.1" min="0.5" max="10" value="2.0" 
                     oninput="setAntiNoisingMultiplier(this.value); atualizarInfoMultiplier()">
              <small id="info-multiplier" style="color: var(--cor-texto-secundario); display: block; margin-top: 0.25rem;">
                Valor atual: 2.0x desvio padr√£o
              </small>
              <small style="color: var(--cor-info); display: block; margin-top: 0.25rem;">
                üí° Valores maiores = mais agressivo na remo√ß√£o de ru√≠do
              </small>
            </div>
            
            <div>
              <label>A√ß√µes de An√°lise de Ru√≠do</label>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                <button onclick="startNoiseAnalysis()" class="btn btn-info">
                  üîç Analisar Ru√≠do (Shift+A)
                </button>
                <button onclick="resetNoiseAnalysis()" class="btn btn-secundario">
                  üîÑ Resetar An√°lise
                </button>
              </div>
              <small style="color: var(--cor-texto-secundario); display: block; margin-top: 0.5rem;">
                A an√°lise leva 5 segundos com a balan√ßa vazia e est√°vel
              </small>
            </div>
          </div>
        </section>

        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--cor-borda);">
          <div class="grid-container">
            <div>
              <h3>Comando de Tara (<kbd>Shift+T</kbd>)</h3>
              <p style="font-size: 0.875rem; color: var(--cor-texto-secundario); margin-bottom: 0.75rem;">Zera a
                balan√ßa.
                Use com o prato vazio.</p><button onclick="tare()" class="btn btn-primario">Zerar (Tara)</button>
            </div>
            <div>
              <h3>Calibra√ß√£o (<kbd>Shift+C</kbd>)</h3>
              <p style="font-size: 0.875rem; color: var(--cor-texto-secundario); margin-bottom: 0.75rem;">Coloque um
                peso
                de
                massa conhecida (em gramas) e digite o valor.</p>
              <div style="display: flex; align-items: center; gap: 0.5rem;"><input id="massaCalibracao" type="number"
                  step="any" placeholder="Massa em gramas" style="width: 12rem;"><button onclick="calibrar()"
                  class="btn btn-aviso">Calibrar</button></div>
            </div>
          </div>
        </div>
      </div>
      <div id="abaGravacoes" class="tabcontent">
        

        <div style="padding: 1rem; border: 1px dashed var(--cor-borda); border-radius: 0.5rem; margin-bottom: 1.5rem;">
          <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">üì• Importar Teste Est√°tico (.txt)</h3>
          <p style="font-size: 0.75rem; color: var(--cor-texto-secundario); margin-bottom: 0.75rem;">
            Importe arquivos de texto (ex: sa√≠das de simula√ß√£o FxT) no formato *tempo [s] for√ßa [N]*.</p>
          <input type="file" id="importar-arquivo-motor" accept=".txt,.log" style="width: auto; margin-right: 10px;">
          <input type="text" id="nome-importacao" placeholder="Nome da sess√£o importada" style="max-width: 200px;">
          <button onclick="importarGravacaoExterna()" class="btn btn-info" style="margin-top: 10px;">
            Salvar Importa√ß√£o
          </button>
        </div>

        <div style="padding: 1rem; border: 1px dashed var(--cor-primaria); border-radius: 0.5rem; margin-bottom: 1.5rem; background: rgba(52, 152, 219, 0.05);">
          <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">üì§ Importar Grava√ß√£o Exportada (.json)</h3>
          <p style="font-size: 0.75rem; color: var(--cor-texto-secundario); margin-bottom: 0.75rem;">
            Restaure grava√ß√µes previamente exportadas em formato JSON. Todas as informa√ß√µes da sess√£o ser√£o recuperadas.</p>
          <input type="file" id="importar-json" accept=".json,application/json" style="width: auto; margin-right: 10px;">
          <button onclick="importarGravacaoJSON()" class="btn btn-sucesso" style="margin-top: 10px;">
            üì• Importar JSON
          </button>
        </div>

        <div id="lista-gravacoes" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
      </div>
        
        <hr style="border: 0; border-top: 1px solid var(--cor-borda); margin: 2rem 0;">

        
      </div>
      <div id="abaConexao" class="tabcontent">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Configura√ß√µes de Conex√£o</h2>
        <p style="font-size: 0.875rem; color: var(--cor-texto-secundario); margin-bottom: 1rem;">
          Configure o endere√ßo do servidor WebSocket para ambientes de desenvolvimento.
        </p>
        <div>
          <label for="ws-url">URL do Servidor WebSocket</label>
          <input type="text" id="ws-url" placeholder="ws://[2804:4950:1:803e:78c5:d2ff:fe30:2650]:81">
          <span class="info-text" style="font-size: 0.85em; color: var(--cor-texto-secundario); margin-top: 0.5rem; display: block;">
            Ex: ws://seu_endereco_ipv4:81 ou ws://[seu_endereco_ipv6]:81
          </span>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <button onclick="salvarWsUrl()" class="btn btn-sucesso">Salvar e Reconectar</button>
          <button onclick="resetarWsUrl()" class="btn btn-secundario">üîÑ Restaurar Padr√£o</button>
        </div>
      </div>
    </main>

    <footer id="footer-atalhos">
      <div class="footer-section footer-brand">
        <h3>üöÄ GFIG - Balan√ßa Serial</h3>
      </div>
      
      <div class="footer-section footer-status">
        <div class="status-item">
          <span class="status-label">WebSocket:</span>
          <div id="ws-indicator" class="status-indicator" title="Desconectado"></div>
          <span id="ws-text">Desconectado</span>
        </div>
        <div class="status-item">
          <span class="status-label">MySQL:</span>
          <div id="mysql-indicator" class="status-indicator" title="MySQL Desconectado"></div>
          <span id="mysql-text">Desconectado</span>
        </div>
        <div class="status-item">
          <span class="status-label">‚öñÔ∏è Balan√ßa:</span>
          <span id="balanca-status">...</span>
        </div>
      </div>
      
      <div class="footer-section footer-time">
        <span class="time-label">üïê Servidor:</span>
        <span id="server-clock">--:--:--</span>
        <button onclick="syncServerTime()" class="btn btn-sync" title="Sincronizar com a hora do navegador">üîÑ</button>
      </div>
      
      <div class="footer-section footer-shortcuts">
        <span class="shortcuts-title">‚ö° ATALHOS:</span>
        <div class="shortcuts-grid">
          <span class="shortcut-item"><span class="shortcut-label">Tara:</span> <kbd>Shift</kbd>+<kbd>T</kbd></span>
          <span class="shortcut-item"><span class="shortcut-label">Calibra√ß√£o:</span> <kbd>Shift</kbd>+<kbd>C</kbd></span>
          <span class="shortcut-item"><span class="shortcut-label">Ru√≠do:</span> <kbd>Shift</kbd>+<kbd>A</kbd></span>
          <span class="shortcut-item"><span class="shortcut-label">Debug:</span> <kbd>Shift</kbd>+<kbd>D</kbd></span>
          <span class="shortcut-item"><span class="shortcut-label">Pausar:</span> <kbd>P</kbd></span>
          <span class="shortcut-item"><span class="shortcut-label">Limpar:</span> <kbd>L</kbd></span>
        </div>
      </div>
      
      <div class="footer-section footer-theme">
        <button id="theme-toggle" class="btn-theme-toggle" title="Alternar tema">üåô</button>
      </div>
    </footer>

    <div id="notification-area"></div>

    <div id="fullscreen-chart-modal" class="fullscreen-modal-overlay">
      <button id="btn-exit-fullscreen" class="btn btn-perigo" style="position: absolute; top: 30px; right: 20px; z-index: 1001;">‚úñ Sair da Tela Cheia</button>
      <!-- Chart and controls will be moved here by JavaScript -->
    </div>
  </div>

</body>

</html>
