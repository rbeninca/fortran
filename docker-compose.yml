version: '3.8'
services:
  balanca:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: balanca
    restart: always
    depends_on:
    - db
    mem_limit: 512m
    devices:
    - /dev/ttyUSB0:/dev/ttyUSB0
    cap_add:
    - SYS_TIME
    environment:
      SERIAL_PORT: /dev/ttyUSB0
      SERIAL_BAUD: '921600'
      WS_PORT: '81'
      WS_PORT_V6: '82'
      HTTP_PORT: '80'
      MYSQL_HOST: localhost
      MYSQL_USER: balanca_user
      MYSQL_PASSWORD: balanca_password
      MYSQL_DB: balanca_gfig
      MYSQL_ROOT_PASSWORD: Hilquias
      TZ: America/Sao_Paulo
    volumes:
    - ./:/app
    working_dir: /app/data
    command:
    - python
    - /app/server.py
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
    network_mode: host
  db:
    image: mariadb:11
    container_name: balanca_mysql
    restart: always
    mem_limit: 256m
    mem_reservation: 128m
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MYSQL_DATABASE: balanca_gfig
      MYSQL_USER: balanca_user
      MYSQL_PASSWORD: balanca_password
      TZ: America/Sao_Paulo
    volumes:
    - mysql_data:/var/lib/mysql
    - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    secrets:
    - db_root_password
    ports:
    - 3306:3306
    networks:
    - balanca_network
    healthcheck:
      test:
      - CMD-SHELL
      - mariadb-admin ping -h localhost -u balanca_user -p'balanca_password' || exit
        1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
networks:
  balanca_network:
    driver: bridge
volumes:
  mysql_data: null
secrets:
  db_root_password:
    file: ./db_root_password.txt
